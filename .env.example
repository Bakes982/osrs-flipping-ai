# ─── OSRS Flipping AI — Environment Variables ───────────────────────────────
# Copy this file to .env and fill in your values.
# Never commit .env to source control.

# ── MongoDB ──────────────────────────────────────────────────────────────────
MONGODB_URL=mongodb://localhost:27017
DATABASE_NAME=osrs_flipping_ai
REDIS_URL=

# ── URLs (update for production) ─────────────────────────────────────────────
FRONTEND_URL=http://localhost:5173
BACKEND_URL=http://localhost:8001

# ── Discord OAuth2 ───────────────────────────────────────────────────────────
# Create an application at https://discord.com/developers/applications
# Add redirect URI: http://localhost:8001/api/auth/callback
DISCORD_CLIENT_ID=
DISCORD_CLIENT_SECRET=
DISCORD_REDIRECT_URI=http://localhost:8001/api/auth/callback

# ── Auth ─────────────────────────────────────────────────────────────────────
# Random secret for signing session tokens — generate with:
#   python -c "import secrets; print(secrets.token_hex(32))"
AUTH_SECRET=

# Comma-separated Discord user IDs allowed to log in (leave empty to use DB-managed allowlist)
ALLOWED_DISCORD_IDS=

# ── Server ───────────────────────────────────────────────────────────────────
PORT=8001

# ── Chunk-2 scoring config ────────────────────────────────────────────────────
VOL_REF_MODE=fixed
VOL_REF_FIXED=0.02
VOL_REF_DAILY_MEDIAN=0.02
TREND_REF=0.01
DECAY_REF=0.25
SPREAD_CV_REF=0.5
LIQ_FREQ_REF_SECONDS=60
LIQ_SPREAD_PCT_REF=0.05
FILL_A0=-0.2
FILL_A1=2.0
FILL_A2=1.2
FILL_A3=1.0
FILL_A4=1.2
FILL_T_MIN=2
FILL_T_MAX=120
MARGIN_REF=50000
ROI_REF=5.0
GPH_REF=10000000
GE_TAX_CAP_ENABLED=false

# Runtime mode
# api    -> serve FastAPI only
# worker -> run background loops only (deploy as separate Railway worker service)
RUN_MODE=api

# Worker resilience / test controls
WORKER_RETRY_INITIAL_SECONDS=2
WORKER_RETRY_MAX_SECONDS=60
WORKER_RUN_ONCE=false
WORKER_RUN_ONCE_SECONDS=0.05

# Flip cache tuning
FLIPS_CACHE_TTL_SECONDS=180
FLIPS_CACHE_WARM_INTERVAL_SECONDS=30
FLIPS_FRESH_MAX_PER_MINUTE=6

# Plugin auth + endpoint rate limits
ALLOW_ANON=false
TOP5_RATE_LIMIT_PER_MINUTE=60
TOP_RATE_LIMIT_PER_MINUTE=20
TOP_REQUIRE_API_KEY=false

# Worker circuit breaker / data quality guardrails
WORKER_CIRCUIT_FAILURE_THRESHOLD=5
WORKER_CIRCUIT_OPEN_SECONDS=300
SCORE_STALE_MAX_MINUTES=45
WORKER_OK_MAX_AGE_SECONDS=180

# ── PR9: Strategy Mode ────────────────────────────────────────────────────────
# When set to a valid strategy mode, new user accounts will default to that
# strategy instead of "steady". Values: steady | steady_spice | spice_only
# Example: set to "steady_spice" for the owner account's default.
FORCE_DEFAULT_STRATEGY_MODE=

# ── PR10: Recommendation Dampening / Hysteresis ───────────────────────────────
# Number of consecutive worker cycles an item must qualify before appearing
# in the top list. Higher = less flicker but slower to surface new items.
DAMPENING_K=3

# Once eligible, an item stays visible even if confidence dips this many
# percentage points below the minimum threshold (0-1 scale × 100).
HYSTERESIS_CONF_MARGIN=5

# Same margin applied to total_score (0-100 scale).
HYSTERESIS_SCORE_MARGIN=5

# ── PR11: Dump Detector ───────────────────────────────────────────────────────
# Window (minutes) used to measure short-term price return for dump detection.
DUMP_SHORT_RETURN_WINDOW_MIN=10

# Dump signal thresholds (0-100 scale):
#   score < DUMP_WATCH_THRESHOLD  → signal = "none"
#   score < DUMP_HIGH_THRESHOLD   → signal = "watch"
#   score >= DUMP_HIGH_THRESHOLD  → signal = "high"
DUMP_WATCH_THRESHOLD=40
DUMP_HIGH_THRESHOLD=70

# Number of consecutive high-dump cycles before a Discord alert fires.
# Prevents alert spam from transient spikes.
DUMP_ALERT_PERSISTENCE=2

# Items with dump_risk_score >= these thresholds are vetoed from their bucket.
DUMP_CORE_VETO_THRESHOLD=70
DUMP_SPICE_VETO_THRESHOLD=50

# Discord webhook URL for dump alerts (optional).
# DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...

# ── PR12: Backtest Endpoint ───────────────────────────────────────────────────
# Admin key required in X-Backtest-Key header to call GET /backtest/run.
# Leave empty to allow unauthenticated access (development only).
BACKTEST_ADMIN_KEY=

# Maximum days a single backtest request may span.
BACKTEST_MAX_DAYS=30

# ── Trade plan defaults ───────────────────────────────────────────────────────
# Default capital (GP) used when computing trade plans if no user capital is set.
DEFAULT_CAPITAL_GP=50000000

# ── Dump alert v2 filtering & cooldown ───────────────────────────────────────
DUMP_ALERT_MIN_PRICE_GP=100000       # ignore cheap items (< 100k GP buy price)
DUMP_ALERT_MIN_PROFIT_GP=10000       # ignore near-zero-profit items
DUMP_ALERT_COOLDOWN_MINUTES=60       # silence per-item after alert fires

# ── Dump Detector v2 — quality filters ───────────────────────────────────────
# Minimum insta-sell price to consider (skip cheap junk items).
DUMP_V2_MIN_PRICE_GP=500000

# Minimum % drop from the 4h reference average to count as a dump.
DUMP_V2_MIN_DROP_PCT=4.0

# Minimum combined 5m volume (sold_5m + bought_5m) — confirms active trading.
DUMP_V2_MIN_VOLUME_TRADES=25

# Minimum sell-side ratio sold/(sold+bought) — confirms panic selling.
DUMP_V2_MIN_SELL_RATIO=0.80

# Minimum net profit per item after GE tax (GP).
DUMP_V2_MIN_PROFIT_PER_ITEM=2000

# Minimum estimated total profit (profit_per_item × qty_to_buy) in GP.
DUMP_V2_MIN_TOTAL_PROFIT=150000

# Per-item alert cooldown in minutes — prevents the same item spamming alerts.
DUMP_V2_COOLDOWN_MINUTES=60

# Position cap as a fraction of DEFAULT_CAPITAL_GP used for dump trade sizing.
DUMP_V2_POSITION_CAP_PCT=0.10
